<!--

    ShinyProxy

    Copyright (C) 2016-2021 Open Analytics

    ===========================================================================

    This program is free software: you can redistribute it and/or modify
    it under the terms of the Apache License as published by
    The Apache Software Foundation, either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    Apache License for more details.

    You should have received a copy of the Apache License
    along with this program.  If not, see <http://www.apache.org/licenses/>

-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
    <head>
        <title th:text="${title}"></title>

        <!-- META -->
        <meta name="description" content="App collection from IRCCS San Camillo Hospital. Apps can be useful for both researchers and clinicians.">
        <meta name="keywords" content="Shiny, R, Neuroscience, Research, Clinical">
        <meta name="author" content="IRCCS San Camillo">

        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <link rel="stylesheet" media="screen" th:href="@{${resourcePrefix} + ${bootstrapCss}}"/>
        <!-- <link rel="stylesheet" media="screen" th:href="@{/assets/css/bootstrap-3.4.1/bootstrap.min.css}"/> -->
        <link rel="stylesheet" media="screen" th:href="@{/assets/css/main.css}"/>
        <link rel="stylesheet" th:href="@{/assets/css/font-awesome-4.7.0/css/font-awesome.min.css}">
        <script th:src="@{${resourcePrefix} + ${jqueryJs}}"></script>
        <script th:src="@{${resourcePrefix} + ${bootstrapJs}}"></script>
        <script th:src="@{${resourcePrefix} + ${handlebars}}"></script>
        <script th:src="@{${resourcePrefix} + '/js/shiny.app.js' }"></script>
        <script th:src="@{${resourcePrefix} + '/js/shiny.api.js' }"></script>
        <script th:src="@{${resourcePrefix} + '/js/shiny.connections.js'}"></script>
        <script th:src="@{${resourcePrefix} + '/js/shiny.instances.js' }"></script>
        <script th:src="@{${resourcePrefix} + '/js/shiny.ui.js' }"></script>
        <script th:src="@{${resourcePrefix} + '/js/shiny.common.js'}"></script>
        <script th:src="@{${resourcePrefix} + '/handlebars/precompiled.js'}"></script>
        <script th:src="@{/assets/js/fuse.js}"></script>
    </head>
    <body>
        <!-- navigation bar -->
        <div th:replace="~{fragments/navbar :: navbar}"></div>

        <div class="description">
            <div class="description-subtitle">
                <span class="lang-en">IRCCS San Camillo Hospital<br>Interactive Applications for Research and Clinical Practice</span>
                <span class="lang-it">Ospedale San Camillo IRCCS<br>Interactive Applications for Research and Clinical Practice</span>
            </div>
            <div class="description-text">
                <span class="lang-en">
                    Welcome to the IRCCS San Camillo Hospital App Collection. <br><br>
                    On this page, you will find a curated selection of applications developed at IRCCS San Camillo Hospital. These tools have been created to serve two main purposes:
                    <br><br>
                    <a href="#apps-clinical"><strong>Clinical Support</strong> <i class="fa fa-arrow-circle-o-down" aria-hidden="true"></i></a><br>
                    Some apps function as practical tools to assist clinicians in their daily work—such as classifying patient performance against normative datasets or streamlining specific clinical assessments.
                    <br><br>
                    <a href="#apps-scientific"><strong>Scientific Communication</strong> <i class="fa fa-arrow-circle-o-down" aria-hidden="true"></i></a><br>
                    Other apps are designed to provide interactive visualizations of results published in scientific articles, enhancing the clarity and accessibility of complex data. This approach aligns with the principles of Open Science, promoting transparency, reproducibility, and wider dissemination of scientific knowledge. By making research outputs more interactive and publicly accessible, we aim to support a more inclusive and collaborative scientific ecosystem.
                    <br><br>
                    Each application includes detailed instructions and information about its intended use. We encourage you to explore them individually to better understand their features and potential applications.
                    <br>
                    If you have any questions or need further information, please do not hesitate to contact the respective author listed for each app.
                    <br><br>
                    All the source code for this website and the associated applications is openly available on <a href="https://github.com/SanCamillo-NeurophysiologyLab/shiny-server">GitHub&nbsp;<i class="fa fa-github" aria-hidden="true"></i></a>. 
                    <br>
                    For general inquiries or technical information, please contact alessandro.tonin@hsancamillo.it.
                </span>
                <span class="lang-it">
                    Benvenuti nella raccolta di applicazioni dell'IRCCS Ospedale San Camillo. <br><br>
                    In questa pagina troverete una selezione curata di applicazioni sviluppate presso l'IRCCS Ospedale San Camillo. Questi strumenti sono stati creati per rispondere a due principali esigenze:
                    <br><br>
                    <a href="#apps-clinical"><strong>Supporto Clinico</strong> <i class="fa fa-arrow-circle-o-down" aria-hidden="true"></i></a><br>
                    Alcune applicazioni sono strumenti pratici pensati per assistere i clinici nel lavoro quotidiano, ad esempio nella classificazione delle prestazioni dei pazienti rispetto a dati normativi o nella semplificazione di specifiche valutazioni cliniche.
                    <br><br>
                    <a href="#apps-scientific"><strong>Comunicazione Scientifica</strong> <i class="fa fa-arrow-circle-o-down" aria-hidden="true"></i></a><br>
                    Altre applicazioni offrono visualizzazioni interattive dei risultati pubblicati in articoli scientifici, migliorando la chiarezza e l’accessibilità dei dati complessi. Questo approccio è in linea con i principi della Scienza Aperta, promuovendo trasparenza, riproducibilità e una più ampia diffusione della conoscenza scientifica. Rendendo i risultati della ricerca più interattivi e accessibili, vogliamo sostenere un ecosistema scientifico più inclusivo e collaborativo.
                    <br><br>
                    Ogni applicazione include istruzioni dettagliate e informazioni sul suo utilizzo previsto. Vi invitiamo a esplorarle singolarmente per comprenderne meglio le caratteristiche e le possibili applicazioni.
                    <br>
                    Per qualsiasi domanda o richiesta di informazioni aggiuntive, non esitate a contattare l’autore indicato per ciascuna applicazione.
                    <br><br>
                    Tutto il codice sorgente di questo sito e delle applicazioni associate è disponibile pubblicamente su <a href="https://github.com/SanCamillo-NeurophysiologyLab/shiny-server">GitHub&nbsp;<i class="fa fa-github" aria-hidden="true"></i></a>. 
                    <br>
                    Per richieste generali o informazioni tecniche, contattare alessandro.tonin@hsancamillo.it.
                </span>
            </div>
        </div>
        <!-- Search bar -->
        <div class="form-group d-flex align-items-center mb-3">
            <!-- <span class="lang-en"> -->
                <label for="searchInput" class="lang-en mb-0 mr-2 font-weight-bold">Search apps:</label>
                <label for="searchInput" class="lang-it mb-0 mr-2 font-weight-bold">Cerca app:</label>
                <input type="text"
                    id="searchInput"
                    class="form-control w-auto"
                    data-placeholder-en="Search apps..."
                    data-placeholder-it="Scrivi per cercare..."
                    placeholder="Type to search..."
                    oninput="debouncedSearch()" />
            <!-- </span> -->
            <!-- <span class="lang-it">
                <label for="searchInput-it" class="mb-0 mr-2 font-weight-bold">Cerca app:</label>
                <input type="text"
                   id="searchInput-it"
                   class="form-control w-auto"
                   placeholder="Scrivi per cercare..."
                   oninput="debouncedSearch()" />
            </span> -->
        </div>
          <!-- All the apps -->
        <th:block th:each="group: ${templateGroups}">
            <div class="title-apps lang-en" th:text="${group.properties.get('display-name')}"></div>
            <div class="title-apps lang-it" th:text="${group.properties.get('display-name_it')}"></div>
            <div class="container group-apps" th:id="'apps-' + ${group.id}">
                <div class="no-apps-message lang-en hidden">
                    <p>No apps available in this group.</p>
                </div>
                <div class="no-apps-message lang-it hidden">
                    <p>Nessuna applicazione trovata</p>
                </div>
                <div th:each="app: ${groupedApps.get(group.id)}">
                    <div class="card"
                        th:data-id="${app.id}"
                        th:data-title="${app.displayName ?: ''}" 
                        th:data-title_it="${@thymeleaf.getTemplateProperty(app.id, 'display-name_it') ?: ''}" 
                        th:data-description="${app.description ?: ''}" 
                        th:data-description_it="${@thymeleaf.getTemplateProperty(app.id, 'description_it') ?: ''}" 
                        th:data-author="${@thymeleaf.getTemplateProperty(app.id, 'author') ?: ''}"
                        th:data-article="${@thymeleaf.getTemplateProperty(app.id, 'article') ?: ''}" 
                        th:data-keywords="${@thymeleaf.getTemplateProperty(app.id, 'keywords') ?: ''}" >
                        <div class="card-title lang-en" th:text="${app.displayName == null} ? ${app.id} : ${app.displayName}"></div>
                        <div class="card-title lang-it" th:text="${@thymeleaf.getTemplateProperty(app.id, 'display-name_it') ?: app.displayName ?: app.id}"></div>
                        <div class="card-logo lang-en">
                            <img class="img-responsive" th:if="${appLogos.get(app) != null}"
                                alt="Screenshot of the app"
                                th:with="logo=${appLogos.get(app)}" th:height="${logo.height}"
                                th:src="${logo.src}" th:style="${logo.style}" th:width="${logo.width}">
                        </div>
                        <div class="card-logo lang-it">
                            <img class="img-responsive" th:if="${appLogos.get(app) != null}"
                                alt="Immagine dell'applicazione"
                                th:with="logo=${appLogos.get(app)}" th:height="${logo.height}"
                                th:src="${logo.src}" th:style="${logo.style}" th:width="${logo.width}">
                        </div>
                        <div class="card-description lang-en" th:if="${app.description != null}" th:text="${app.description}"></div>
                        <div class="card-description lang-it" th:if="${@thymeleaf.getTemplateProperty(app.id, 'description_it') != null or app.description != null}" th:text="${@thymeleaf.getTemplateProperty(app.id, 'description_it') ?: app.description}"></div>
                        <div class="card-author lang-en" th:if="${@thymeleaf.getTemplateProperty(app.id, 'author')}">
                            <strong>Author: </strong><span th:text="${@thymeleaf.getTemplateProperty(app.id, 'author')}"></span> <a th:if="${@thymeleaf.getTemplateProperty(app.id, 'contact')}" th:href="'mailto:'+${@thymeleaf.getTemplateProperty(app.id, 'contact')}" th:attr="aria-label=|Send email to ${@thymeleaf.getTemplateProperty(app.id, 'author')}|"><i class="fa fa-envelope email-icon" aria-hidden="true"></i></a>
                            <!-- <a th:if="${@thymeleaf.getTemplateProperty(app.id, 'contact')}" class="email-icon" th:href="'mailto:'+${@thymeleaf.getTemplateProperty(app.id, 'contact')}" title="Contact Author">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                    viewBox="0 0 16 16">
                                <path d="M0 4a2 2 0 012-2h12a2 2 0 012 2v.217l-8 4.8-8-4.8V4zm0 1.383v6.634l5.803-3.482L0 5.383zM6.761 8.83l-6.52 3.913A2 2 0 002 14h12a2 2 0 001.76-1.257l-6.52-3.913L8 9.583l-1.239-.753zM16 5.383l-5.803 3.152L16 12.017V5.383z"/>
                                </svg>
                            </a> -->
                        </div>
                        <div class="card-author lang-it" th:if="${@thymeleaf.getTemplateProperty(app.id, 'author')}">
                            <strong>Autore: </strong><span th:text="${@thymeleaf.getTemplateProperty(app.id, 'author')}"></span> <a th:if="${@thymeleaf.getTemplateProperty(app.id, 'contact')}" th:href="'mailto:'+${@thymeleaf.getTemplateProperty(app.id, 'contact')}" th:attr="aria-label=|Invia email a ${@thymeleaf.getTemplateProperty(app.id, 'author')}|"><i class="fa fa-envelope email-icon" aria-hidden="true"></i></a>
                            <!-- <a th:if="${@thymeleaf.getTemplateProperty(app.id, 'contact')}" class="email-icon" th:href="'mailto:'+${@thymeleaf.getTemplateProperty(app.id, 'contact')}" title="Contact Author">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                    viewBox="0 0 16 16">
                                <path d="M0 4a2 2 0 012-2h12a2 2 0 012 2v.217l-8 4.8-8-4.8V4zm0 1.383v6.634l5.803-3.482L0 5.383zM6.761 8.83l-6.52 3.913A2 2 0 002 14h12a2 2 0 001.76-1.257l-6.52-3.913L8 9.583l-1.239-.753zM16 5.383l-5.803 3.152L16 12.017V5.383z"/>
                                </svg>
                            </a> -->
                        </div>
                        <!-- <div class="card-contact" th:if="${@thymeleaf.getTemplateProperty(app.id, 'contact')}"><strong>Contact: </strong><span th:text="${@thymeleaf.getTemplateProperty(app.id, 'contact')}"></span></div> -->
                        <div class="card-article lang-en" th:if="${@thymeleaf.getTemplateProperty(app.id, 'article')}"><strong>Article: </strong><span th:text="${@thymeleaf.getTemplateProperty(app.id, 'article')}"></span></div>
                        <div class="card-article lang-it" th:if="${@thymeleaf.getTemplateProperty(app.id, 'article')}"><strong>Articolo: </strong><span th:text="${@thymeleaf.getTemplateProperty(app.id, 'article')}"></span></div>
                        <div class="card-doi" th:if="${@thymeleaf.getTemplateProperty(app.id, 'doi')}"><strong>DOI: </strong><a th:href="'https://doi.org/' + ${@thymeleaf.getTemplateProperty(app.id, 'doi')}"><span th:text="${@thymeleaf.getTemplateProperty(app.id, 'doi')}"></span></a></div>
                        <a th:href="@{/app/}+${app.id}" class="btn"><span class="lang-en">Launch App</span><span class="lang-it">Avvia Applicazione</span></a>
                    </div>
                </div>
            </div>
        </th:block>

        <div th:if="${myAppsMode == 'Inline'}" class="col-md-5 col-lg-4 col-xs-12 myApps-inline">
            <div class="myApps-title">
                <h4>My apps</h4>
            </div>
            <div id="myApps" class="myApps">
            </div>
            <div class="myApps-footer">
                <button onclick="Shiny.common.onStopAllApps();" id="stop-all-apps-btn" type="button"
                        class="btn pull-left btn-danger">Stop all apps
                </button>
                <button type="button" disabled class="btn pull-left btn-danger" id="stopping-all-apps-btn">Stopping
                    all apps...
                </button>
            </div>
        </div>

        <div th:replace="fragments/modal :: modal"></div>

        <script type="text/javascript" th:inline="javascript">
            $(window).on('load', function () {
                window.Shiny.common.init([[${contextPath}]], [[${application_name}]], [[${spInstance}]], [[${appMaxInstances}]], [[${myAppsMode}]], [[${pauseSupported}]]);
                window.Shiny.common.startIndex();
                // Try saved language first
                let lang = localStorage.getItem('language');

                // If not saved, detect browser language
                if (!lang) {
                const browserLang = navigator.language || navigator.userLanguage; // e.g. "en-US"
                lang = browserLang.split('-')[0]; // get "en", "fr", "it", etc.
                }

                // Default to English if unsupported
                if (!['en', 'it'].includes(lang)) {
                lang = 'en';
                }

                setLanguage(lang);
            });

            // Debounce setup
            let debounceTimer;

            function debouncedSearch() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(runFuzzySearch, 300); // 300ms delay
            }

            // Initialize Fuse.js
            const appCards = Array.from(document.querySelectorAll('.card'));

            // Create data array from DOM
            const apps = appCards.map(card => ({
            element: card,
            title: card.dataset.title || '',
            title_it: card.dataset.title_it || '',
            description: card.dataset.description || '',
            description_it: card.dataset.description_it || '',
            author: card.dataset.author || '',
            article: card.dataset.article || '',
            keywords: card.dataset.keywords || '',
            }));

            const fuse = new Fuse(apps, {
            keys: ['title', 'title_it', 'description', 'description_it', 'author', 'article', 'keywords'],
            threshold: 0.3, // 0 = exact match, 1 = match anything
            ignoreLocation: true,
            });

            function runFuzzySearch() {
                let lang = localStorage.getItem('language');
                // let input = "";
                const input = document.getElementById('searchInput').value.trim();
                // if (lang == "it") {
                //     input = document.getElementById('searchInput-it').value.trim();
                // } else {
                //     input = document.getElementById('searchInput').value.trim();
                // }

                // Show all if input is empty
                if (input === '') {
                    appCards.forEach(card => card.classList.remove('hidden'));
                } else {
                    // Perform fuzzy search
                    const results = fuse.search(input);

                    // Hide all cards
                    appCards.forEach(card => card.classList.add('hidden'));

                    // Show matched cards
                    results.forEach(result => {
                        result.item.element.classList.remove('hidden');
                    });
                }

                // Check empty groups

                document.querySelectorAll('.group-apps').forEach(group => {
                    const visibleCards = Array.from(group.querySelectorAll('.card'))
                        .filter(card => !card.classList.contains('hidden'));

                    const noAppsMessage = group.querySelectorAll('.no-apps-message');
                    if (visibleCards.length === 0) {
                        noAppsMessage.forEach(message => message.classList.remove('hidden'));
                    } else {
                        noAppsMessage.forEach(message => message.classList.add('hidden'));
                    }
                });
            }
        </script>
    </body>
</html>
